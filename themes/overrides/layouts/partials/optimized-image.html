{{/* layouts/partials/optimized-image.html */}}
{{/* Expects a dict with "Page" (.Page), "Src" (string, may include leading slash), and optional "Alt" */}}

{{ $page := .Page }}
{{ $raw  := .Src }}
{{/* Strip a leading slash if present so GetMatch/resources.Get can find it */}}
{{ $src  := replaceRE "^/" "" $raw }}
{{ $alt  := or .Alt $page.Title }}

// Try as a page resource (leaf bundle)
{{ $orig := $page.Resources.GetMatch $src }}

{{ if not $orig }}
  {{/* If not in a bundle, try site assets */}}
  {{ $orig = resources.Get $src }}
{{ end }}

{{ if $orig }}
  {{/* Convert to AVIF */}}
  {{ $avif := $orig.Convert "avif" }}

  <picture>
    <source srcset="{{ $avif.RelPermalink }}" type="image/avif">
    <source srcset="{{ $orig.RelPermalink }}" type="{{ $orig.MediaType.Type }}">
    <img
      src="{{ $avif.RelPermalink }}"
      alt="{{ $alt }}"
      loading="lazy"
      decoding="async" />
  </picture>
{{ else }}
  {{/* Fallback for external or missing files */}}
  <img
    src="{{ .Src }}"
    alt="{{ $alt }}"
    loading="lazy"
    decoding="async" />
{{ end }}
